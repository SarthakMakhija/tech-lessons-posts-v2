---
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import FormattedDate from "../../../components/FormattedDate.astro";
import TableOfContents from "../../../components/TableOfContents.astro";

export async function getStaticPaths() {
    const posts = await getCollection("blog", ({ data }) => {
        return import.meta.env.PROD ? data.draft !== true : true;
    });
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: post,
    }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings } = await post.render();

// Related Posts Logic
const allPosts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
});

const stopWords = new Set([
    "a",
    "an",
    "the",
    "in",
    "on",
    "at",
    "for",
    "to",
    "of",
    "and",
    "or",
    "with",
    "by",
]);

function getTitleWords(title: string) {
    return new Set(
        title
            .toLowerCase()
            .split(/\W+/) // Split by non-word chars
            .filter((w) => w.length > 2 && !stopWords.has(w)),
    );
}

const currentTitleWords = getTitleWords(post.data.title);

const relatedPosts = allPosts
    .filter((p) => p.slug !== post.slug) // Exclude current post
    .map((p) => {
        const commonTags =
            p.data.tags?.filter((tag) => post.data.tags?.includes(tag)) || [];

        const otherTitleWords = getTitleWords(p.data.title);
        const commonWords = [...currentTitleWords].filter((w) =>
            otherTitleWords.has(w),
        );

        // Score: Tags are worth 4 (must match at least one), Title words worth 1
        const score = commonTags.length * 4 + commonWords.length;

        return {
            ...p,
            score,
        };
    })
    .filter((p) => p.score >= 4) // Must have at least one common tag (since tag = 4pts)
    .sort((a, b) => {
        if (b.score !== a.score) {
            return b.score - a.score; // Higher score first
        }
        return b.data.pubDate.valueOf() - a.data.pubDate.valueOf(); // Newer first
    })
    .slice(0, 3); // Top 3
---

<Layout
    title={post.data.title}
    description={post.data.description || post.data.title}
>
    <article class="max-w-[1280px] mx-auto min-w-0">
        <div class="lg:grid lg:grid-cols-[1fr_240px] lg:gap-12 items-start">
            <div class="min-w-0">
                <!-- Article Header -->
                <header class="mb-12">
                    <h1
                        class="text-[40px] md:text-[48px] font-sans font-extrabold text-black leading-[1.2] mb-6 tracking-tight"
                    >
                        {post.data.title}
                    </h1>
                    <div
                        class="flex items-center gap-4 text-[16px] text-zinc-500 mb-8 border-b border-zinc-100 pb-8"
                    >
                        <FormattedDate date={post.data.pubDate} />
                        <span>/</span>
                        <span>{post.data.tags?.join(", ") || "Article"}</span>
                    </div>
                    {
                        post.data.heroImage && (
                            <div class="w-full mb-12">
                                <img
                                    width={1020}
                                    height={510}
                                    src={post.data.heroImage}
                                    alt=""
                                    class="w-full rounded-md shadow-sm"
                                />
                                {post.data.caption && (
                                    <p class="text-left text-zinc-500 italic mt-3 text-sm">
                                        {post.data.caption}
                                    </p>
                                )}
                            </div>
                        )
                    }
                </header>

                <!-- Table of Contents (Mobile Only) -->
                {
                    headings.length > 0 && (
                        <div class="lg:hidden bg-gray-50 rounded-lg p-6 mb-12 border border-zinc-100">
                            <h2 class="text-black font-bold font-sans text-[16px] uppercase tracking-wide mb-4">
                                Table of contents
                            </h2>
                            <TableOfContents headings={headings} />
                        </div>
                    )
                }

                <!-- Article Content -->
                <div
                    class="prose prose-lg max-w-none text-black
            [&_h1]:font-serif [&_h1]:font-bold [&_h1]:text-black [&_h1]:text-[36px] [&_h1]:mt-10 [&_h1]:mb-4
            [&_h2]:font-serif [&_h2]:font-bold [&_h2]:text-black [&_h2]:text-[30px] [&_h2]:mt-10 [&_h2]:mb-6
            [&_h3]:font-sans [&_h3]:font-bold [&_h3]:text-black [&_h3]:text-[24px] [&_h3]:mt-10 [&_h3]:mb-4
            [&_h4]:font-sans [&_h4]:font-bold [&_h4]:text-black [&_h4]:text-[18px] [&_h4]:mt-8 [&_h4]:mb-4
            [&_p]:font-sans [&_p]:text-[1.125rem] [&_p]:leading-[1.7777778] [&_p]:text-zinc-800 [&_p]:my-[1em]
            [&_a]:underline [&_a]:decoration-zinc-400 [&_a]:transition-all
            
            /* Table Styling */
            [&_table]:w-full [&_table]:border-collapse [&_table]:my-8 [&_table]:border [&_table]:border-zinc-200 [&_table]:rounded-lg [&_table]:overflow-hidden
            [&_th]:text-left [&_th]:p-3 [&_th]:border-b [&_th]:border-zinc-200 [&_th]:bg-zinc-50 [&_th]:font-semibold [&_th]:text-zinc-900
            [&_td]:p-3 [&_td]:border-b [&_td]:border-zinc-200 [&_td]:text-zinc-700
            [&_tr:last-child_td]:border-0
            
            [&_li]:text-[1.125rem] [&_li]:leading-[1.7777778] [&_li]:text-zinc-800 [&_li]:mb-2
            [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mb-6
            [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mb-6
            [&_img]:rounded-md [&_img]:shadow-lg [&_img]:my-8
            [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-zinc-500 [&_figcaption]:italic [&_figcaption]:mt-[-20px] [&_figcaption]:mb-8
            [&_blockquote]:relative [&_blockquote]:bg-zinc-100 [&_blockquote]:text-zinc-700 [&_blockquote]:p-8 [&_blockquote]:rounded-2xl [&_blockquote]:my-10 [&_blockquote]:not-italic [&_blockquote]:text-[1.1rem] [&_blockquote]:leading-relaxed [&_blockquote]:ml-24
            [&_blockquote::before]:content-[''] [&_blockquote::before]:absolute [&_blockquote::before]:top-8 [&_blockquote::before]:-left-3 [&_blockquote::before]:border-t-[12px] [&_blockquote::before]:border-t-transparent [&_blockquote::before]:border-b-[12px] [&_blockquote::before]:border-b-transparent [&_blockquote::before]:border-r-[16px] [&_blockquote::before]:border-r-zinc-100
            [&_blockquote::after]:content-[''] [&_blockquote::after]:absolute [&_blockquote::after]:-left-32 [&_blockquote::after]:-top-2 [&_blockquote::after]:w-28 [&_blockquote::after]:h-28 [&_blockquote::after]:bg-[url('/avatar.png')] [&_blockquote::after]:bg-contain [&_blockquote::after]:bg-no-repeat [&_blockquote::after]:bg-center [&_blockquote::after]:rounded-full [&_blockquote::after]:border-4 [&_blockquote::after]:border-white [&_blockquote::after]:shadow-md
            [&_pre]:p-6 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:my-8
            [&_code]:font-mono [&_code]:text-[14px] [&_code]:leading-relaxed"
                >
                    <Content />
                </div>

                <!-- Tags Section -->
                {
                    post.data.tags && post.data.tags.length > 0 && (
                        <div class="mt-12 pt-8 border-t border-zinc-100">
                            <div class="flex flex-wrap gap-3">
                                {post.data.tags.map((tag) => (
                                    <div class="flex items-center gap-2 px-3 py-1.5 border border-accent-600 rounded-lg text-accent-600 text-sm font-medium bg-white hover:bg-indigo-50 transition-colors cursor-default">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="14"
                                            height="14"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
                                            <path d="M7 7h.01" />
                                        </svg>
                                        {tag}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                }

                <!-- Related Essays -->
                {
                    relatedPosts.length > 0 && (
                        <div class="mt-12 pt-8 border-t border-zinc-100">
                            <h2 class="text-2xl font-bold font-sans mb-6 text-black">
                                More from Tech Lessons
                            </h2>
                            <div class="grid gap-6 md:grid-cols-2">
                                {relatedPosts.map((related) => (
                                    <a
                                        href={`/en/blog/${related.slug}/`}
                                        class="block p-6 rounded-xl border border-zinc-200 hover:border-zinc-300 hover:shadow-sm transition-all bg-white group"
                                    >
                                        <h3 class="font-sans font-medium text-lg text-zinc-900 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2">
                                            {related.data.title}
                                        </h3>
                                        <div class="text-sm text-zinc-500 font-sans">
                                            <FormattedDate
                                                date={related.data.pubDate}
                                            />
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    )
                }

                <!-- Giscus Comments -->
                <div class="mt-16 pt-8 border-t border-zinc-100">
                    <script
                        src="https://giscus.app/client.js"
                        data-repo="SarthakMakhija/tech-lessons-comments"
                        data-repo-id="R_kgDOJHu3mA"
                        data-category="Announcements"
                        data-category-id="DIC_kwDOJHu3mM4CUxhS"
                        data-mapping="og:title"
                        data-strict="0"
                        data-reactions-enabled="1"
                        data-emit-metadata="0"
                        data-input-position="bottom"
                        data-theme="light"
                        data-lang="en"
                        crossorigin="anonymous"
                        async></script>
                </div>
            </div>

            <!-- Sidebar TOC (Desktop Only) -->
            {
                headings.length > 0 && (
                    <aside class="hidden lg:block sticky top-24 pt-8">
                        <div class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 font-sans">
                            On this page
                        </div>
                        <TableOfContents headings={headings} />
                    </aside>
                )
            }
        </div>
    </article>
</Layout>
