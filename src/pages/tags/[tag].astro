---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const posts = await getCollection("blog", ({ data }) => {
        return import.meta.env.PROD ? data.draft !== true : true;
    });
    const uniqueTags = [
        ...new Set(posts.map((post) => post.data.tags || []).flat()),
    ];

    return uniqueTags.map((tag) => {
        const filteredPosts = posts.filter((post) =>
            post.data.tags?.includes(tag),
        );
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const postsByYear = posts.reduce(
    (acc, post) => {
        const year = post.data.pubDate.getFullYear();
        if (!acc[year]) acc[year] = [];
        acc[year].push(post);
        return acc;
    },
    {} as Record<number, typeof posts>,
);

const years = Object.keys(postsByYear)
    .sort((a, b) => Number(b) - Number(a))
    .map(Number);
---

<Layout
    title={`Essays tagged with ${tag}`}
    description={`Essays tagged with ${tag}`}
>
    <div class="max-w-[800px] mx-auto">
        <section>
            <h1 class="text-3xl font-mono font-bold mb-8">
                Essays tagged with <span class="text-slate-600">#{tag}</span>
            </h1>

            <div class="flex flex-col">
                {
                    years.map((year) => (
                        <div class="mb-8">
                            {postsByYear[year].map((post, index) => (
                                <div class="group flex items-baseline py-2 border-b border-zinc-100 hover:border-zinc-200 transition-colors">
                                    <div class="w-16 font-mono text-sm text-zinc-900 shrink-0 font-bold">
                                        {index === 0 ? year : ""}
                                    </div>

                                    <div class="w-16 font-mono text-sm text-zinc-900 shrink-0 hidden sm:block font-bold">
                                        {post.data.pubDate.toLocaleDateString(
                                            "en-GB",
                                            {
                                                day: "2-digit",
                                                month: "2-digit",
                                            },
                                        )}
                                    </div>

                                    <a
                                        href={`/en/blog/${post.slug}/`}
                                        class="font-mono font-medium text-zinc-700 hover:text-black hover:translate-x-1 transition-all"
                                    >
                                        {post.data.title}
                                    </a>
                                </div>
                            ))}
                        </div>
                    ))
                }
            </div>
        </section>
    </div>
</Layout>
